<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Modbus Scan</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-gray-100">
    <div class="max-w-10xl mx-auto p-8 bg-white shadow-2xl">
        <div class="flex justify-center mb-6">
            <div class="p-6 border rounded-2xl shadow-lg bg-white w-full max-w-10xl">
                <div class="flex flex-wrap justify-center items-center gap-6">

                    <!-- Logo -->
                    <div class="flex justify-start items-center">
                        <img src="{{ url_for('static', filename='logo.png') }}" class="h-16 w-auto">
                    </div>

                    <!-- IP Address Card -->
                    <div class="p-4 border rounded-xl shadow-sm bg-yellow-50 min-w-[250px]">
                        <div>
                            <h3 class="font-semibold text-yellow-700 flex items-center gap-2 text-base">
                                üåê IP Address
                            </h3>
                            <div class="mt-3 flex flex-wrap items-center gap-3">
                                <input id="ip_address" type="text" placeholder="127.0.0.1"
                                    class="border px-2 py-1 rounded-lg w-24 focus:ring-2 focus:ring-yellow-400">
                                <input id="ip_port" type="number" placeholder="502"
                                    class="border px-2 py-1 rounded-lg w-16 focus:ring-2 focus:ring-yellow-400">
                                <button id="set_ip"
                                    class="bg-yellow-600 text-white px-4 py-1 rounded-lg hover:bg-yellow-700 transition">
                                    Set
                                </button>
                            </div>
                        </div>
                        <!--<p id="ip_status" class="text-sm text-gray-600"></p>-->
                    </div>

                    <!--Card Num Register-->
                    <div class="p-4 border rounded-xl shadow-sm bg-green-50 min-w-[200px]">
                        <h3 class="font-semibold text-green-700 flex items-center gap-2 text-base">
                            üî¢ Jumlah Register
                        </h3>
                        <div class="mt-3 flex flex-wrap items-center gap-3">
                            <input id="num_registers" type="number" min="1" value="100"
                                class="w-24 text-center border border-gray-300 rounded-lg p-1" />
                            <button id="set_num_registers"
                                class="bg-green-600 text-white px-4 py-1 rounded-lg hover:bg-green-700">
                                Set
                            </button>
                        </div>
                    </div>

                    <!-- Connection Card -->
                    <div class="p-4 border rounded-xl shadow-sm bg-pink-50 min-w-[200px]">
                        <h3 id="status" class="text-red-700 font-semibold flex items-center gap-2 text-base">
                            üî¥ Disconnected
                        </h3>
                        <div class="mt-3 flex flex-wrap items-center gap-4">
                            <button id="connectBtn"
                                class="bg-green-600 text-white px-4 py-1 rounded-lg hover:bg-green-700 transition">
                                Connect
                            </button>
                            <button id="disconnectBtn"
                                class="bg-red-600 text-white px-2 py-1 rounded-lg hover:bg-red-700 transition" disabled>
                                Disconnect
                            </button>
                        </div>
                    </div>

                    <!-- Write Coil -->
                    <div class="p-4 border rounded-xl shadow-sm bg-blue-50 min-w-[250px]">
                        <h3 class="font-semibold text-blue-700 flex items-center gap-2 text-base">
                            üí° Write Coil
                        </h3>
                        <div class="mt-3 flex flex-wrap items-center gap-4">
                            <input id="coil_addr" type="number" placeholder="Addr"
                                class="border border-gray-300 px-2 py-1 rounded-lg w-20 focus:ring-2 focus:ring-blue-400 disabled"
                                disabled>
                            <label class="flex items-center gap-1">
                                <input id="coil_val" type="checkbox" class="disabled" disabled> ON
                            </label>
                            <button id="write_coil"
                                class="bg-blue-600 text-white px-4 py-1 rounded-lg hover:bg-blue-700 transition disabled"
                                disabled>
                                Write
                            </button>
                        </div>
                    </div>

                    <!-- Write Holding Register -->
                    <div class="p-4 border rounded-xl shadow-sm bg-purple-50 min-w-[250px]">
                        <h3 class="font-semibold text-purple-700 flex items-center gap-2 text-base">
                            üìù Write Holding Register
                        </h3>
                        <div class="mt-3 flex flex-wrap items-center gap-4">
                            <input id="hr_addr" type="number" placeholder="Addr"
                                class="border border-gray-300 px-2 py-1 rounded-lg w-20 focus:ring-2 focus:ring-purple-400 disabled"
                                disabled>
                            <input id="hr_val" type="number" placeholder="Val"
                                class="border border-gray-300 px-2 py-1 rounded-lg w-16 focus:ring-2 focus:ring-purple-400 disabled"
                                disabled>
                            <button id="write_hr"
                                class="bg-purple-600 text-white px-4 py-1 rounded-lg hover:bg-purple-700 transition disabled"
                                disabled>
                                Write
                            </button>
                        </div>
                    </div>
                </div>
                <!--<p id="ip_status" class="text-sm text-gray-600"></p>-->
            </div>
        </div>

        <!-- Tables Section -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <table class="w-full text-sm border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-2 py-1 text-blue-700" colspan="5">Coils</th>
                        </tr>
                    </thead>
                    <tbody id="coils"></tbody>
                </table>
            </div>

            <div>
                <table class="w-full text-sm border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-2 py-1 text-green-700" colspan="5">Discrete Inputs</th>
                        </tr>
                    </thead>
                    <tbody id="discrete_inputs"></tbody>
                </table>
            </div>

            <div>
                <table class="w-full text-sm border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-2 py-1 text-purple-700" colspan="5">Holding Register</th>
                        </tr>
                    </thead>
                    <tbody id="holding"></tbody>
                </table>
            </div>

            <div>
                <table class="w-full text-sm border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-2 py-1 text-orange-700" colspan="5">Input Register</th>
                        </tr>
                    </thead>
                    <tbody id="input_regs"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let refreshInterval;
        let numRegisters = 100; // default

        function updateTable(count) {
            const tableContainer = document.getElementById('table_container');
            tableContainer.innerHTML = ""; // hapus tabel lama

            let tableHTML = `<table class="w-full border border-gray-300">
        <thead>
            <tr class="bg-gray-200">
                <th class="border p-2">Register</th>
                <th class="border p-2">Value</th>
            </tr>
        </thead>
        <tbody>`;

            for (let i = 0; i < count; i++) {
                tableHTML += `
            <tr>
                <td class="border p-2 text-center">${i}</td>
                <td class="border p-2 text-center" id="value_${i}">0</td>
            </tr>`;
            }

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        }

        // tombol set
        document.getElementById('set_num_registers').addEventListener('click', function () {
            const count = parseInt(document.getElementById('num_registers').value);
            if (isNaN(count) || count <= 0) {
                alert("Jumlah register harus lebih dari 0!");
                return;
            }

            fetch('/set_num_registers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ count })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        numRegisters = count; // update nilai di frontend
                        updateTable(numRegisters); // refresh tabel aja
                    }
                });
        });

        // pertama kali load halaman
        window.onload = function () {
            fetch('/get_num_registers')
                .then(res => res.json())
                .then(data => {
                    numRegisters = data.count || 100;
                    document.getElementById('num_registers').value = numRegisters;
                    updateTable(numRegisters);
                });
        };



        function updateTable(id, data) {
            const tbody = $(`#${id}`);
            tbody.empty();
            const total = data.length, cols = 5, perCol = Math.ceil(total / cols);
            let html = '<tr>';
            for (let c = 0; c < cols; c++) {
                html += '<td valign="top"><table class="w-full text-xs border">';
                html += '<thead><tr><th class="px-1 py-0.5 bg-gray-100">Addr</th><th class="px-1 py-0.5 bg-gray-100">Val</th></tr></thead><tbody>';
                for (let i = c * perCol; i < Math.min((c + 1) * perCol, total); i++) {
                    let val = data[i];
                    let bg = (val === true || val > 0) ? 'bg-green-100' : 'bg-red-100';
                    html += `<tr class="${bg}"><td class="px-2">${i}</td><td class="px-2">${val}</td></tr>`;
                }
                html += '</tbody></table></td>';
            }
            html += '</tr>';
            tbody.append(html);
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const status = $('#status');
            const connectBtn = $('#connectBtn');
            const disconnectBtn = $('#disconnectBtn');

            $('.disabled').prop('disabled', !connected);
            if (connected) {
                status.text('üü¢ Connected').removeClass('text-red-600').addClass('text-green-600');
                connectBtn.addClass('disabled').prop('disabled', true);
                disconnectBtn.removeClass('disabled').prop('disabled', false);
                startRefreshing();
            } else {
                status.text('üî¥ Disconnected').removeClass('text-green-600').addClass('text-red-600');
                connectBtn.removeClass('disabled').prop('disabled', false);
                disconnectBtn.addClass('disabled').prop('disabled', true);
                stopRefreshing();
                updateTable('coils', Array(numRegisters).fill(false));
                updateTable('discrete_inputs', Array(numRegisters).fill(false));
                updateTable('holding', Array(numRegisters).fill(0));
                updateTable('input_regs', Array(numRegisters).fill(0));

            }
        }

        function startRefreshing() {
            refreshInterval = setInterval(refreshData, 1000);
            refreshData();
        }

        function stopRefreshing() {
            if (refreshInterval) clearInterval(refreshInterval);
        }

        function refreshData() {
            if (!isConnected) return;
            $.get('/read-data', function (res) {
                updateTable('coils', res.coils);
                updateTable('discrete_inputs', res.discrete_inputs);
                updateTable('holding', res.holding);
                updateTable('input_regs', res.input_regs);
            }).fail(() => updateConnectionStatus(false));
        }

        function checkConnection() {
            $.get('/check-connection', function (res) {
                updateConnectionStatus(res.connected);
            }).fail(() => updateConnectionStatus(false));
        }

        // ========== EVENTS ==========
        $('#set_ip').click(function () {
            const ip = $('#ip_address').val().trim();
            if (!ip) return $('#ip_status').text('‚ö†Ô∏è Please enter a valid IP ‚ö†Ô∏è').addClass('text-red-600');
            $.ajax({
                url: '/set-ip', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ ip, port: $('#ip_port').val().trim() || 502 }),
                success: (res) => {
                    $('#ip_status').text(res.message)
                        .removeClass('text-red-600 text-gray-600')
                        .addClass(res.success ? 'text-green-600' : 'text-red-600');

                    // Jika koneksi sebelumnya ditutup otomatis, update status UI
                    if (res.disconnected) {
                        updateConnectionStatus(false);
                    }
                },

                error: () => $('#ip_status').text('‚ùå Server error').addClass('text-red-600')
            });
        });

        $('#connectBtn').click(() => $.post('/connect', res =>
            res.success ? updateConnectionStatus(true) : alert('Connection failed: ' + res.message)
        ).fail(() => alert('Connection failed: Server error')));

        $('#disconnectBtn').click(() => $.post('/disconnect', res => res.success && updateConnectionStatus(false)));

        $('#write_coil').click(() => {
            if (!isConnected) return;
            $.post('/write-coil', {
                address: $('#coil_addr').val(),
                value: $('#coil_val').is(':checked')
            }, refreshData);
        });

        $('#write_hr').click(() => {
            if (!isConnected) return;
            $.post('/write-holding', {
                address: $('#hr_addr').val(),
                value: $('#hr_val').val()
            }, refreshData);
        });

        $(document).ready(() => checkConnection());
    </script>
</body>

</html>